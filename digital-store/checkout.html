<script src="https://app.sandbox.midtrans.com/snap/snap.js"
data-client-key="Mid-client-0rxk4NYmmZpsfrJV"></script>

<h2>Checkout</h2>
<div id="checkout"></div>
<button id="payBtn">Bayar Sekarang</button>

<script>
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

async function loadCheckout() {
  const res = await fetch("/data/products.json");
  const products = await res.json();
  const product = products.find(p => p.id === id);

  if (!product) {
    document.body.innerHTML = "Produk tidak ditemukan";
    return;
  }

  document.getElementById("checkout").innerHTML = `
    <h3>${product.name}</h3>
    <p>Rp ${product.price}</p>
  `;

  document.getElementById("payBtn").onclick = async function() {
    const response = await fetch("/api/create-transaction", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ product_id: id })
    });

    const data = await response.json();

    snap.pay(data.token, {
      onSuccess: function() {
        window.location.href = "success.html";
      },
      onPending: function() {
        alert("Menunggu pembayaran...");
      },
      onError: function() {
        window.location.href = "failed.html";
      }
    });
  };
}

loadCheckout();
</script>